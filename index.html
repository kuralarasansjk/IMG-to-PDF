<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to PDF Pro - Multi-Page</title>
    <!-- CSS and Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow-x: hidden;
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .image-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .image-card:hover {
            transform: translateX(4px);
            border-color: #bfdbfe;
        }
        .loader {
            border-top-color: #3b82f6;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #image-list::-webkit-scrollbar {
            width: 5px;
        }
        #image-list::-webkit-scrollbar-track {
            background: transparent;
        }
        #image-list::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-2xl w-full">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight mb-2">Image to PDF</h1>
            <p class="text-slate-500">Fast, local, and multi-page processing.</p>
        </header>

        <!-- Main Card -->
        <main id="app-container" class="glass-morphism rounded-3xl shadow-2xl p-6 md:p-8 border border-white">
            
            <!-- Upload Zone -->
            <div id="upload-section" class="space-y-6">
                <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-2xl p-10 md:p-20 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition-all group">
                    <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                    <div class="flex flex-col items-center">
                        <div class="bg-blue-50 p-5 rounded-full mb-4 group-hover:scale-110 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                        </div>
                        <p class="text-xl font-bold text-slate-700">Choose images to convert</p>
                        <p class="text-sm text-slate-400 mt-2">Drag and drop or click to browse</p>
                    </div>
                </div>
            </div>

            <!-- List & Management Section -->
            <div id="management-section" class="hidden space-y-6">
                <div class="flex items-center justify-between border-b border-slate-100 pb-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Queue (<span id="file-count">0</span>)</h2>
                    </div>
                    <div class="flex gap-3">
                        <button id="sort-btn" class="text-xs font-bold text-slate-500 hover:text-blue-600 flex items-center bg-slate-100 px-3 py-1.5 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                            </svg>
                            Sort A-Z
                        </button>
                        <button id="add-more-btn" class="text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded-lg transition-colors">
                            + Add More
                        </button>
                    </div>
                </div>

                <!-- Sortable List Container -->
                <div id="image-list" class="space-y-2 max-h-[350px] overflow-y-auto pr-1">
                    <!-- Dynamic list items will go here -->
                </div>

                <div class="pt-4 border-t border-slate-100 space-y-4">
                    <div>
                        <label for="filename" class="block text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Save as PDF Name</label>
                        <div class="relative flex items-center">
                            <input type="text" id="filename" placeholder="my-document" 
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all pr-16 bg-white font-medium">
                            <span class="absolute right-4 text-slate-400 font-bold text-sm">.pdf</span>
                        </div>
                    </div>

                    <button id="convert-btn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-xl transition-all flex items-center justify-center space-x-2 active:scale-[0.98]">
                        <span>Generate & Download PDF</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden flex flex-col items-center justify-center py-10">
                <div class="loader ease-linear rounded-full border-4 border-slate-100 h-16 w-16 mb-4"></div>
                <p class="text-slate-800 font-bold text-lg">Creating PDF...</p>
                <p id="loading-progress" class="text-slate-400 text-sm mt-1">Processing locally...</p>
            </div>
        </main>

        <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none text-sm font-medium z-50">
            Success!
        </div>
    </div>

    <script>
        // Use a safer initialization pattern to prevent DOM access issues
        window.addEventListener('load', function() {
            const { jsPDF } = window.jspdf;

            // Element cache with safety checks
            const elements = {
                fileInput: document.getElementById('file-input'),
                uploadSection: document.getElementById('upload-section'),
                managementSection: document.getElementById('management-section'),
                imageList: document.getElementById('image-list'),
                fileCountSpan: document.getElementById('file-count'),
                filenameInput: document.getElementById('filename'),
                convertBtn: document.getElementById('convert-btn'),
                addMoreBtn: document.getElementById('add-more-btn'),
                sortBtn: document.getElementById('sort-btn'),
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingProgress: document.getElementById('loading-progress'),
                toast: document.getElementById('toast'),
                dropZone: document.getElementById('drop-zone')
            };

            // Verify all critical elements exist
            for (const key in elements) {
                if (!elements[key]) {
                    console.error(`Missing element: ${key}`);
                    return;
                }
            }

            let images = []; 

            // --- Event Listeners ---

            elements.dropZone.addEventListener('click', () => elements.fileInput.click());
            elements.addMoreBtn.addEventListener('click', () => elements.fileInput.click());
            elements.sortBtn.addEventListener('click', sortImages);

            elements.fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFiles(Array.from(e.target.files));
                    elements.fileInput.value = ''; 
                }
            });

            elements.dropZone.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                elements.dropZone.classList.add('border-blue-400', 'bg-blue-50/50'); 
            });
            
            elements.dropZone.addEventListener('dragleave', () => {
                elements.dropZone.classList.remove('border-blue-400', 'bg-blue-50/50');
            });

            elements.dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.dropZone.classList.remove('border-blue-400', 'bg-blue-50/50');
                if (e.dataTransfer.files.length) {
                    handleFiles(Array.from(e.dataTransfer.files));
                }
            });

            // --- Business Logic ---

            async function handleFiles(files) {
                const imageFiles = files.filter(f => f.type.startsWith('image/'));
                
                if (imageFiles.length === 0) {
                    showToast('No valid images found');
                    return;
                }

                elements.uploadSection.classList.add('hidden');
                elements.managementSection.classList.remove('hidden');

                for (const file of imageFiles) {
                    const data = await readFileAsDataURL(file);
                    const id = Math.random().toString(36).substr(2, 9);
                    images.push({
                        id,
                        data,
                        name: file.name,
                        type: file.type.includes('png') ? 'PNG' : 'JPEG'
                    });
                }

                if (!elements.filenameInput.value && images.length > 0) {
                    const first = images[0].name;
                    elements.filenameInput.value = first.substring(0, first.lastIndexOf('.')) || 'converted-pdf';
                }

                renderImageList();
                showToast(`Added ${imageFiles.length} file(s)`);
            }

            function readFileAsDataURL(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            function sortImages() {
                images.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
                renderImageList();
                showToast('Sorted by filename');
            }

            function renderImageList() {
                elements.imageList.innerHTML = '';
                elements.fileCountSpan.textContent = images.length;

                images.forEach((img, index) => {
                    const item = document.createElement('div');
                    item.className = 'image-card flex items-center bg-white p-3 rounded-xl border border-slate-200 gap-4';
                    item.innerHTML = `
                        <div class="w-10 h-10 rounded-lg bg-slate-50 overflow-hidden flex-shrink-0 border border-slate-100">
                            <img src="${img.data}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="text-sm font-semibold text-slate-700 truncate">${img.name}</p>
                            <p class="text-[10px] uppercase font-bold text-slate-400">Page ${index + 1}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button data-action="up" data-index="${index}" class="p-1.5 hover:bg-blue-50 rounded-lg text-slate-300 hover:text-blue-600 transition-colors ${index === 0 ? 'opacity-0 pointer-events-none' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                            </button>
                            <button data-action="down" data-index="${index}" class="p-1.5 hover:bg-blue-50 rounded-lg text-slate-300 hover:text-blue-600 transition-colors ${index === images.length - 1 ? 'opacity-0 pointer-events-none' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </button>
                            <button data-action="remove" data-id="${img.id}" class="p-1.5 hover:bg-red-50 rounded-lg text-slate-300 hover:text-red-500 transition-colors ml-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    `;
                    
                    // Attach event listeners to buttons within the card
                    item.querySelector('[data-action="up"]')?.addEventListener('click', () => moveItem(index, -1));
                    item.querySelector('[data-action="down"]')?.addEventListener('click', () => moveItem(index, 1));
                    item.querySelector('[data-action="remove"]')?.addEventListener('click', () => removeItem(img.id));
                    
                    elements.imageList.appendChild(item);
                });

                if (images.length === 0) {
                    elements.managementSection.classList.add('hidden');
                    elements.uploadSection.classList.remove('hidden');
                }
            }

            function moveItem(index, direction) {
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < images.length) {
                    const temp = images[index];
                    images[index] = images[newIndex];
                    images[newIndex] = temp;
                    renderImageList();
                }
            }

            function removeItem(id) {
                images = images.filter(img => img.id !== id);
                renderImageList();
            }

            elements.convertBtn.addEventListener('click', async () => {
                if (images.length === 0) return;

                const name = elements.filenameInput.value.trim() || 'combined-document';
                elements.managementSection.classList.add('hidden');
                elements.loadingOverlay.classList.remove('hidden');

                // Let the UI breathe before heavy PDF lifting
                setTimeout(async () => {
                    try {
                        let pdf = null;

                        for (let i = 0; i < images.length; i++) {
                            elements.loadingProgress.textContent = `Processing image ${i + 1} of ${images.length}...`;
                            const imgObj = images[i];
                            
                            const img = new Image();
                            img.src = imgObj.data;
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = () => reject(new Error(`Failed to load image: ${imgObj.name}`));
                            });

                            const width = img.width;
                            const height = img.height;
                            const orientation = width > height ? 'l' : 'p';

                            if (i === 0) {
                                pdf = new jsPDF({
                                    orientation: orientation,
                                    unit: 'px',
                                    format: [width, height],
                                    hotfixes: ["px_scaling"] // Fixes some scaling issues in older browser environments
                                });
                            } else {
                                pdf.addPage([width, height], orientation);
                            }

                            pdf.addImage(imgObj.data, imgObj.type, 0, 0, width, height);
                        }

                        pdf.save(`${name}.pdf`);
                        showToast('PDF Exported Successfully!');
                    } catch (err) {
                        console.error(err);
                        showToast('Error creating PDF');
                    } finally {
                        elements.loadingOverlay.classList.add('hidden');
                        elements.managementSection.classList.remove('hidden');
                    }
                }, 150);
            });

            function showToast(message) {
                elements.toast.textContent = message;
                elements.toast.style.opacity = '1';
                elements.toast.style.transform = 'translate(-50%, -15px)';
                setTimeout(() => {
                    elements.toast.style.opacity = '0';
                    elements.toast.style.transform = 'translate(-50%, 0)';
                }, 3000);
            }
        });
    </script>
</body>
</html>